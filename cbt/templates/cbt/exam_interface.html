{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ exam.title }}</title>
    <style>
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; font-family: sans-serif; overflow: hidden; }
        header { background: #333; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; height: 50px; }

        .split-screen { display: flex; flex: 1; height: calc(100vh - 50px); overflow: hidden; }

        /* Left Pane: PDF Scrollable */
        .left-pane { flex: 1; border-right: 1px solid #ccc; background: #525659; overflow-y: auto; display: flex; flex-direction: column; align-items: center; position: relative; }
        .pdf-page { margin: 10px 0; box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* Right Pane: Question Area */
        .right-pane { width: 400px; display: flex; flex-direction: column; background: #f5f5f5; border-left: 2px solid #ddd; }
        .question-area { padding: 20px; background: white; flex: 1; overflow-y: auto; }
        .controls { padding: 10px; display: flex; justify-content: space-between; background: #eee; border-top: 1px solid #ccc; }
        .palette-container { padding: 10px; height: 200px; overflow-y: auto; background: #e0e0e0; border-top: 1px solid #999; }

        /* Grid and Buttons */
        .question-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .palette-btn { padding: 10px; border: 1px solid #ccc; cursor: pointer; background: white; }
        .palette-btn.current { border: 2px solid blue; font-weight: bold; }
        .palette-btn.answered { background-color: #4CAF50; color: white; }
        .palette-btn.not_answered { background-color: #F44336; color: white; }
        .palette-btn.marked_for_review { background-color: #9C27B0; color: white; }
        .palette-btn.ans_marked_for_review { background-color: #2196F3; color: white; }

        /* Calculator Modal */
        #calc-modal {
            display: none; position: absolute; top: 100px; left: 100px;
            z-index: 2000; background: #fff; border: 2px solid #333;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5); width: 300px;
        }
        .calc-header { background: #333; color: white; padding: 10px; cursor: move; display: flex; justify-content: space-between; }
        .calc-body { padding: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .calc-body button { padding: 15px; font-size: 16px; cursor: pointer; }
        .calc-display { grid-column: span 4; margin-bottom: 10px; padding: 10px; font-size: 20px; text-align: right; width: 100%; box-sizing: border-box; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';</script>
</head>
<body>

<header>
    <div>{{ exam.title }}</div>
    <div>Time Left: <span id="timer">00:00:00</span></div>
    <div>
        <button onclick="toggleCalculator()">Calculator</button>
        <button onclick="submitExam()" style="background: red; color: white; border: none; padding: 5px 10px; margin-left: 10px;">Submit</button>
    </div>
</header>

<div class="split-screen">
    <div class="left-pane" id="pdf-container">
        </div>

    <div class="right-pane">
        <div class="question-area">
            <h3>Question <span id="q-number">1</span> <span style="font-size:0.8em; color:gray;">(<span id="q-type"></span>)</span></h3>
            <div id="q-input-container"></div>
        </div>
        <div class="controls">
            <button onclick="markForReview()">Mark for Review</button>
            <button onclick="clearResponse()">Clear Response</button>
            <button onclick="saveAndNext()">Save & Next</button>
        </div>
        <div class="palette-container">
            <h4>Question Palette</h4>
            <div class="question-grid" id="palette-grid"></div>
        </div>
    </div>
</div>

<div id="calc-modal">
    <div class="calc-header" id="calc-header">
        <span>Scientific Calculator</span>
        <button onclick="toggleCalculator()" style="background:none; border:none; color:white; font-weight:bold;">X</button>
    </div>
    <div class="calc-body">
        <input type="text" id="calc-display" class="calc-display" readonly>
        <button onclick="calcClear()">C</button>
        <button onclick="calcInput('/')">/</button>
        <button onclick="calcInput('*')">*</button>
        <button onclick="calcBackspace()">âŒ«</button>

        <button onclick="calcInput('7')">7</button>
        <button onclick="calcInput('8')">8</button>
        <button onclick="calcInput('9')">9</button>
        <button onclick="calcInput('-')">-</button>

        <button onclick="calcInput('4')">4</button>
        <button onclick="calcInput('5')">5</button>
        <button onclick="calcInput('6')">6</button>
        <button onclick="calcInput('+')">+</button>

        <button onclick="calcInput('1')">1</button>
        <button onclick="calcInput('2')">2</button>
        <button onclick="calcInput('3')">3</button>
        <button onclick="calcEval()" style="grid-row: span 2; background: #ddd;">=</button>

        <button onclick="calcInput('0')" style="grid-column: span 2;">0</button>
        <button onclick="calcInput('.')">.</button>
    </div>
</div>

<script>
    // --- Data ---
    const pdfUrl = "{{ exam.question_paper.url }}";
    const questions = {{ questions_json|safe }};
    const attemptId = {{ attempt.id }};
    const csrfToken = '{{ csrf_token }}';
    let timeLeft = {{ exam.duration_minutes }} * 60; // Reset logic needed if resuming

    // --- State ---
    let responses = {};
    const savedState = {{ attempt.current_state|safe }};
    if (savedState && savedState.responses) responses = savedState.responses;
    let currentQIndex = 0;

    // --- PDF Logic (Continuous Scroll) ---
    async function loadPDF() {
        const loadingTask = pdfjsLib.getDocument(pdfUrl);
        const pdf = await loadingTask.promise;
        const container = document.getElementById('pdf-container');

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const scale = 1.5; // Fixed reasonable zoom
            const viewport = page.getViewport({scale: scale});

            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-page';
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            container.appendChild(canvas);

            const renderContext = {
                canvasContext: canvas.getContext('2d'),
                viewport: viewport
            };
            page.render(renderContext);
        }
    }
    loadPDF();

    // --- Exam Logic ---
    function loadQuestion(index) {
        currentQIndex = index;
        const q = questions[index];
        document.getElementById('q-number').innerText = q.number;
        document.getElementById('q-type').innerText = q.type;

        // Render Inputs
        const container = document.getElementById('q-input-container');
        container.innerHTML = '';
        const resp = responses[q.id] || {value: null};

        if (q.type === 'MCQ') {
            ['A', 'B', 'C', 'D'].forEach(opt => {
                container.innerHTML += `<div><input type="radio" name="ans" value="${opt}" ${resp.value === opt ? 'checked' : ''} onchange="updateResp()"> ${opt}</div>`;
            });
        } else if (q.type === 'MSQ') {
             ['A', 'B', 'C', 'D'].forEach(opt => {
                 const checked = resp.value && resp.value.includes(opt) ? 'checked' : '';
                container.innerHTML += `<div><input type="checkbox" name="ans" value="${opt}" ${checked} onchange="updateResp()"> ${opt}</div>`;
            });
        } else if (q.type === 'NAT') {
            container.innerHTML = `<input type="text" id="nat-val" value="${resp.value || ''}" oninput="updateResp()">`;
        }
        renderPalette();
    }

    function updateResp() {
        const q = questions[currentQIndex];
        let val = null;
        if (q.type === 'MCQ') {
            const el = document.querySelector('input[name="ans"]:checked');
            if(el) val = el.value;
        } else if (q.type === 'MSQ') {
            const els = document.querySelectorAll('input[name="ans"]:checked');
            val = Array.from(els).map(e => e.value).join(',');
            if(val === '') val = null;
        } else if (q.type === 'NAT') {
            val = document.getElementById('nat-val').value;
            if(val === '') val = null;
        }

        if (!responses[q.id]) responses[q.id] = {};
        responses[q.id].value = val;
        responses[q.id].status = val ? 'answered' : 'not_answered';
    }

    function renderPalette() {
        const grid = document.getElementById('palette-grid');
        grid.innerHTML = '';
        questions.forEach((q, idx) => {
            const btn = document.createElement('button');
            btn.className = 'palette-btn';
            btn.innerText = q.number;

            if (idx === currentQIndex) btn.classList.add('current');

            const r = responses[q.id];
            if (r && r.status) btn.classList.add(r.status);
            else btn.classList.add('not_visited');

            btn.onclick = () => loadQuestion(idx);
            grid.appendChild(btn);
        });
    }

    function saveAndNext() {
        if(currentQIndex < questions.length - 1) loadQuestion(currentQIndex + 1);
    }

    function markForReview() {
        const qId = questions[currentQIndex].id;
        if(!responses[qId]) responses[qId] = {value:null};
        responses[qId].status = responses[qId].value ? 'ans_marked_for_review' : 'marked_for_review';
        renderPalette();
    }

    function clearResponse() {
        const qId = questions[currentQIndex].id;
        if(responses[qId]) {
            responses[qId].value = null;
            responses[qId].status = 'not_answered';
        }
        loadQuestion(currentQIndex);
    }

    // --- Calculator ---
    function toggleCalculator() {
        const el = document.getElementById('calc-modal');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    function calcInput(v) { document.getElementById('calc-display').value += v; }
    function calcClear() { document.getElementById('calc-display').value = ''; }
    function calcBackspace() {
        const d = document.getElementById('calc-display');
        d.value = d.value.slice(0, -1);
    }
    function calcEval() {
        const d = document.getElementById('calc-display');
        try { d.value = eval(d.value); } catch(e) { d.value = 'Error'; }
    }

    // Make Calculator Draggable
    const draggable = document.getElementById('calc-modal');
    const header = document.getElementById('calc-header');
    let isDragging = false, offsetX, offsetY;
    header.onmousedown = function(e) {
        isDragging = true;
        offsetX = e.clientX - draggable.offsetLeft;
        offsetY = e.clientY - draggable.offsetTop;
    };
    document.onmousemove = function(e) {
        if(isDragging) {
            draggable.style.left = (e.clientX - offsetX) + 'px';
            draggable.style.top = (e.clientY - offsetY) + 'px';
        }
    };
    document.onmouseup = function() { isDragging = false; };

    // Init
    loadQuestion(0);
    setInterval(() => {
        timeLeft--;
        const h = Math.floor(timeLeft/3600);
        const m = Math.floor((timeLeft%3600)/60);
        const s = timeLeft%60;
        document.getElementById('timer').innerText = `${h}:${m}:${s}`;

        // Sync Logic here (simplified)
        if(timeLeft % 10 === 0) { // Sync every 10s
             fetch(`/cbt/attempt/${attemptId}/sync/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({responses: responses})
            });
        }
    }, 1000);

    function submitExam() {
        if(confirm("Submit Exam?")) {
             fetch(`/cbt/attempt/${attemptId}/submit/`, {
                method: 'POST',
                headers: {'X-CSRFToken': csrfToken}
            }).then(() => window.location.href = `/cbt/attempt/${attemptId}/result/`);
        }
    }
</script>
</body>
</html>
